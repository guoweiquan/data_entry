# 报名系统后端与数据库联调测试方案

## 1. 背景
该测试方案基于现有报名信息管理系统的设计文档与 `src/routes/enrollmentRoutes.ts` 路由实现，用于指导后端服务与 SQLite 数据库的联调测试工作，确保核心 CRUD、搜索筛选以及导出功能在真实数据库交互下稳定可靠。

## 2. 测试目标
- 验证后端 REST API 与数据库在真实数据流转中的正确性、稳定性与一致性。
- 覆盖正向与逆向输入，确保数据校验、错误处理、导出能力符合设计要求。
- 检查日志记录、`requestId` 追踪与异常路径，确保可观察性与可追溯性。
- 识别并缓解性能瓶颈、安全隐患与数据一致性风险。

## 3. 测试范围
- `/api/enrollments` 相关接口：列表查询、单条查询、新增、更新、删除。
- `/api/enrollments/export` 导出接口：支持原始全集与筛选结果导出。
- 数据库 `enrollments` 表及其索引、约束，数据写入、更新、删除、查询场景。
- 中间件：参数校验、请求 ID 生成、错误处理、日志输出。
- 不在本轮范围：鉴权与权限控制、批量删除、统计功能、前端 UI 行为。

## 4. 测试环境
- **代码分支**：`main`
- **运行方式**：使用 `npm run build && npm run start` 或 `npm run dev` 启动后端服务，监听本地端口（假设 3000）。
- **数据库**：本地 SQLite，使用迁移脚本初始化 `enrollments` 表，必要时清理并重建。
- **工具**：Postman / Thunder Client、curl、Jest + Supertest（可选）、SQLite 浏览器或命令行、日志查看工具。
- **配置**：确保 `.env` 或配置文件中数据库路径可写，启用详细日志级别。

## 5. 数据准备
- 创建基础课程数据集（如 "少儿编程1班"、"机器人社团"、"STEAM" 等）。
- 预置 3~5 条报名记录，涵盖不同性别、课程、联系方式，便于搜索与导出校验。
- 准备无效输入样例：缺失必填字段、非法性别值、超长备注、异常联系方式。
- 准备安全测试 payload：SQL 注入片段 `"' OR '1'='1"`、XSS 片段 `"<script>alert('x')</script>"`。

## 6. 联调流程
1. **环境校验**：确认服务启动无报错，数据库文件生成，迁移执行成功。
2. **基础连通性**：访问 `GET /api/health`（如有）或列表接口，确认 HTTP 返回 200。
3. **CRUD 功能验证**：按照测试用例执行新增、查询、更新、删除，并检查数据库实际变更。
4. **筛选与导出**：验证不同筛选组合返回结果，核对导出文件字段、编码、数据范围。
5. **异常路径**：触发校验失败、资源不存在、数据库异常（模拟只读或断连）等场景，确认错误响应与日志。
6. **并发与性能**：模拟并发请求，对比响应时间、数据库锁情况、日志是否完整。
7. **安全与健壮性**：执行 SQL 注入、XSS、超长输入等安全测试，确保防护有效。
8. **回归检查**：在全部测试结束后再次执行关键正向用例，确认系统状态恢复正常。

## 7. 日志与监控要求
- 确认请求日志包含 `requestId`、方法、路径、状态码、耗时。
- 针对异常请求，日志需包含错误堆栈或明确错误信息，便于排查。
- 保留导出操作日志，记录筛选参数、生成文件名、响应耗时。
- 建议在测试期间将日志级别调至 `debug` 或 `verbose`，便于收集细节。

## 8. 风险与缓解措施
- **数据库锁竞争**：并发写入可能导致锁超时，需监控日志并评估事务策略。
- **大数据量导出**：若数据量大，导出可能阻塞主线程，建议限制导出分页或异步生成。
- **异常数据清理**：逆向测试后需清理脏数据，确保回归测试准确。
- **配置差异**：测试与生产环境配置差异可能导致行为不同，建议保持一致或在文档中标记差异。

## 9. 测试用例一览
| 编号 | 测试名称 | 前置条件 | 步骤 | 预期结果 |
| --- | --- | --- | --- | --- |
| TC-01 | 新增报名成功 | 服务运行，数据库可写 | 1. POST `/api/enrollments` 提交合法数据<br>2. 查询数据库 `enrollments` 表 | 1. 响应 201，返回体含新 `id` 与字段值<br>2. 表中存在对应记录，`created_at` 有值 |
| TC-02 | 新增缺失必填字段 | 服务运行 | POST `/api/enrollments` 缺少 `name` 字段 | 响应 400，返回校验错误信息，数据库无新记录 |
| TC-03 | 新增非法性别值 | 服务运行 | POST `/api/enrollments`，`gender="未知"` | 响应 400，提示性别取值非法 |
| TC-04 | 新增联系方式格式错误 | 服务运行 | POST `/api/enrollments`，`contact="123"` | 响应 400，提示联系方式格式错误 |
| TC-05 | 获取报名列表默认分页 | 预置 ≥3 条数据 | GET `/api/enrollments` 不带分页参数 | 响应 200，返回默认 `page=1`、`pageSize` 正确，数据数量符合默认值 |
| TC-06 | 列表分页第二页 | 预置 ≥15 条数据 | GET `/api/enrollments?page=2&pageSize=10` | 响应 200，返回第 2 页 5 条数据，`total` 正确 |
| TC-07 | 列表按姓名模糊搜索 | 预置包含“张”字的数据 | GET `/api/enrollments?name=张` | 响应 200，仅返回姓名包含“张”的记录 |
| TC-08 | 列表多条件筛选 | 预置不同课程、性别数据 | GET `/api/enrollments?course=机器人社团&gender=女` | 响应 200，返回符合课程与性别的记录，无交集时返回空数组 |
| TC-09 | 获取单条报名详情成功 | 预置目标记录 | GET `/api/enrollments/{id}` | 响应 200，字段与数据库一致 |
| TC-10 | 获取不存在的报名 | 无该 id | GET `/api/enrollments/999999` | 响应 404，返回资源不存在提示 |
| TC-11 | 更新报名成功 | 预置目标记录 | PUT `/api/enrollments/{id}` 修改课程、备注 | 响应 200，返回更新后的数据，数据库字段同步更新，`updated_at` 变更 |
| TC-12 | 更新违反校验规则 | 预置目标记录 | PUT `/api/enrollments/{id}`，`name=""` | 响应 400，返回校验错误，数据库未变更 |
| TC-13 | 删除报名成功 | 预置目标记录 | DELETE `/api/enrollments/{id}` | 响应 204 或 200，无响应体或返回删除确认，数据库删除该记录 |
| TC-14 | 删除不存在的报名 | 无该 id | DELETE `/api/enrollments/999999` | 响应 404，返回资源不存在提示 |
| TC-15 | 导出全部数据 CSV | 预置 ≥5 条数据 | GET `/api/enrollments/export` | 响应 200，返回 CSV 文件，列顺序与设计一致，包含全部记录 |
| TC-16 | 导出筛选结果 CSV | 预置不同课程数据 | GET `/api/enrollments/export?course=少儿编程1班` | 响应 200，仅包含筛选课程记录，导出文件名含时间戳 |
| TC-17 | 导出文件编码校验 | 成功生成 CSV | 打开 CSV，检查编码与换行 | 文件以 UTF-8 编码保存，中文不乱码，行列数正确 |
| TC-18 | 并发新增与列表一致性 | 准备 5 组合法数据 | 并发发送 5 个 POST 请求后 GET 列表 | 所有 POST 响应成功且各自返回唯一 `id`，列表返回 5 条新记录，无重复或丢失 |
| TC-19 | 并发删除冲突处理 | 预置同一记录，仅允许删除一次 | 两个客户端同时 DELETE 同一 `id` | 第一个请求成功删除，第二个收到 404，不引发 500，数据库无残留 |
| TC-20 | SQL 注入防护 | 服务运行 | GET `/api/enrollments?name=' OR '1'='1` | 响应 200，仅返回匹配记录或空数组，无全量泄露，日志无 SQL 错误 |
| TC-21 | XSS 防护验证 | 新增报名 | POST 提交 `remarks="<script>alert('x')</script>"` 后 GET 列表 | 响应 201，存储时进行编码或在响应中转义，前端展示不执行脚本 |
| TC-22 | 超长备注处理 | 服务运行 | POST `remarks` 超过 1000 字 | 响应 400，提示长度超限 |
| TC-23 | 联系方式唯一性确认 | 预置一条联系方式 | POST 相同 `contact` （可选需求） | 若需唯一性：返回 409 且提示冲突；若允许重复：记录需求并标记为风险 |
| TC-24 | 数据库异常恢复 | 模拟数据库只读或断连 | 尝试 POST 新增 | 响应 500 或自定义错误码，日志记录异常细节，恢复连接后可继续正常写入 |
| TC-25 | 请求 ID 日志追踪 | 服务运行 | 发送任意请求并查阅日志 | 响应头或日志包含 `requestId`，日志前后关联一致 |

## 10. 验收标准
- 所有高优先级用例（TC-01 至 TC-22）执行通过，安全类用例无高风险缺陷。
- 导出功能在包含筛选条件时行为正确，文件可在常用办公软件打开。
- 异常路径具备可读日志与明确响应，数据库无脏数据残留。
- 缺陷关闭率达到 100%，或剩余问题经评审确认可延后。

## 11. 交付物
- 本测试方案 Markdown 文档。
- 测试执行记录与缺陷单（Jira/Excel/测试平台）。
- 导出样例文件与数据库备份（可选）。
