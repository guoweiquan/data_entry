# 后端 API 联调测试报告

## 1. 测试概述
- **项目名称**：报名信息管理系统
- **测试时间**：2025-11-09
- **测试环境**：
  - 操作系统：Windows (PowerShell)
  - 后端启动方式：`npm run build` 后执行 `node dist/server.js`
  - 数据库：SQLite (`D:/SQLiteStudio/db/code_buddy`)
- **测试目标**：依据《报名系统后端与数据库联调测试方案》对 `/api/enrollments` 系列接口进行验证，覆盖核心正向流程与关键逆向校验。

## 2. 测试范围
| 接口 | 方法 | 用例编号 | 覆盖情况 |
| --- | --- | --- | --- |
| `/api/enrollments` | GET | TC-05, TC-06, TC-07, TC-08 | ✅ |
| `/api/enrollments/{id}` | GET | TC-09, TC-10 | ✅ |
| `/api/enrollments` | POST | TC-01, TC-02, TC-03, TC-04 | ⚠️ 部分失败 |
| `/api/enrollments/{id}` | PUT | TC-11, TC-12 | ⚠️ 部分失败 |
| `/api/enrollments/{id}` | DELETE | TC-13, TC-14 | ⚠️ 部分失败 |
| `/api/enrollments/export` | GET | TC-15 ~ TC-17 | ❌ 未执行 |
| 并发、安全等其他用例 | TC-18 ~ TC-25 | ❌ 未执行 |

## 3. 测试结果汇总
| 用例编号 | 用例名称 | 结果 | 备注 |
| --- | --- | --- | --- |
| TC-01 | 新增报名成功 | 失败 | 接口返回 400/500，服务器日志提示 JSON 解析失败（`entity.parse.failed`）或内部错误 |
| TC-02 | 新增缺失必填字段 | 通过 | `POST` 缺失 `name`，返回 400 与校验提示 |
| TC-03 | 新增非法性别值 | 无法执行 | 正常请求均返回 400/500，无法进入具体校验分支 |
| TC-04 | 新增联系方式格式错误 | 无法执行 | 同上 |
| TC-05 | 获取报名列表默认分页 | 通过 | 返回 200，分页元信息正常，空数据集 |
| TC-06 | 列表分页第二页 | 失败 | 数据预插入后请求 500，服务器日志报写入异常（详见第 4 节）|
| TC-07 | 列表按姓名模糊搜索 | 未执行 | 受写入失败影响，数据准备不足 |
| TC-08 | 列表多条件筛选 | 未执行 | 同上 |
| TC-09 | 获取单条报名详情成功 | 失败 | 准备数据时插入异常导致接口无有效记录 |
| TC-10 | 获取不存在的报名 | 通过 | 返回 404 |
| TC-11 | 更新报名成功 | 未执行 | 数据准备失败 |
| TC-12 | 更新违反校验规则 | 未执行 | 同上 |
| TC-13 | 删除报名成功 | 未执行 | 同上 |
| TC-14 | 删除不存在的报名 | 通过 | 返回 404 |
| TC-15 | 导出全部数据 CSV | 未执行 | 受写入失败限制 |
| TC-16 | 导出筛选结果 CSV | 未执行 | 同上 |
| TC-17 | 导出文件编码校验 | 未执行 | 同上 |
| TC-18 ~ TC-25 | 并发 / 安全项 | 未执行 | 未进入执行阶段 |

## 4. 关键问题与日志节选
1. **请求体解析失败**
   - 现象：通过 PowerShell `Invoke-WebRequest` 或 `curl.exe` 提交 JSON 时，服务端返回 `400` 并在日志中记录 `entity.parse.failed`。
   - 日志节选：
     ```
     SyntaxError: Expected property name or '}' in JSON at position 2 (line 1 column 3)
     ...
     body: '{ name:.... }'
     type: 'entity.parse.failed'
     ```
   - 可能原因：
     - PowerShell 默认使用 UTF-16 编码，导致 body 在到达 Express `body-parser` 时出现乱码；
     - 命令中 JSON 未被正确转义，进入服务端后字段名缺少引号。

2. **POST 请求返回 500（服务器内部错误）**
   - 现象：即便更换为 `curl.exe` 并尝试 UTF-8 格式提交，服务器仍返回 500。
   - 相关日志：`服务器内部错误`，未输出详细堆栈。

3. **写入数据库失败**
   - 由于 POST 阶段未成功写入，后续 GET/PUT/DELETE 等依赖真实数据的用例无法继续。

## 5. 测试结论
- 当前后端接口在接收外部 JSON 请求时存在解析异常，导致无法完成新增写入。
- 列表查询（无准备数据情况下）和资源不存在类用例表现正常，说明基础路由和响应封装可用。
- 建议优先排查 `express.json()` 的编码处理、测试工具的请求体格式，并确保在 Windows PowerShell 环境下提交 UTF-8 正确 JSON。

## 6. 后续建议
1. **修复请求解析问题**
   - 在命令行工具中确保 `Content-Type` 为 `application/json; charset=utf-8`，请求体需 UTF-8 编码；
   - 可使用 Postman/Insomnia 等工具验证；
   - 服务端可增加请求体解析异常的详细日志。
2. **补充自动化脚本**
   - 使用 Node.js `fetch` 或 Axios 自带 UTF-8 JSON 字符串提交，避免 PowerShell 编码陷阱；
   - 将数据库准备与断言封装为自动化脚本，便于回归。
3. **待执行用例**
   - 请求解析问题修复后，补测 TC-01/03/04/06/07/08/09/11/12/13/15/16/17 以及并发、安全等用例。

---
*报告生成时间：2025-11-09*